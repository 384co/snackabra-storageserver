<!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><i><font color="#9A1900">/* </font></i>
<i><font color="#9A1900">   Copyright (C) 2019-2021 Magnusson Institute, All Rights Reserved</font></i>

<i><font color="#9A1900">   "Snackabra" is a registered trademark</font></i>

<i><font color="#9A1900">   This program is free software: you can redistribute it and/or</font></i>
<i><font color="#9A1900">   modify it under the terms of the GNU Affero General Public License</font></i>
<i><font color="#9A1900">   as published by the Free Software Foundation, either version 3 of</font></i>
<i><font color="#9A1900">   the License, or (at your option) any later version.</font></i>

<i><font color="#9A1900">   This program is distributed in the hope that it will be useful, but</font></i>
<i><font color="#9A1900">   WITHOUT ANY WARRANTY; without even the implied warranty of</font></i>
<i><font color="#9A1900">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</font></i>
<i><font color="#9A1900">   Affero General Public License for more details.</font></i>

<i><font color="#9A1900">   You should have received a copy of the GNU Affero General Public</font></i>
<i><font color="#9A1900">   License along with this program.  If not, see www.gnu.org/licenses/</font></i>

<i><font color="#9A1900">*/</font></i>



<i><font color="#9A1900">/**</font></i>
<i><font color="#9A1900"> * The DE</font></i><b>BUG</b><i><font color="#9A1900"> flag will do two things that help during development:</font></i>
<i><font color="#9A1900"> * 1. we will skip caching on the edge, which makes it easier to</font></i>
<i><font color="#9A1900"> *    debug.</font></i>
<i><font color="#9A1900"> * 2. we will return an error message on exception in your Response rather</font></i>
<i><font color="#9A1900"> *    than the default 404.html page.</font></i>
<i><font color="#9A1900"> */</font></i>
<b><font color="#0000FF">const</font></b> DEBUG <font color="#990000">=</font> <b><font color="#0000FF">true</font></b>
import <font color="#990000">*</font> as utils from <font color="#FF0000">"./utils.js"</font><font color="#990000">;</font>
<b><font color="#0000FF">export</font></b> <b><font color="#0000FF">default</font></b> <font color="#FF0000">{</font>
  async <b><font color="#000000">fetch</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">,</font> ctx<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> await <b><font color="#000000">handleRequest</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">,</font> ctx<font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>DEBUG<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> e<font color="#990000">.</font>message <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">);</font>
      <font color="#FF0000">}</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Internal service error'</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

async <b><font color="#0000FF">function</font></b> <b><font color="#000000">handleRequest</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font> <font color="#FF0000">{</font>  <i><font color="#9A1900">// not using ctx</font></i>

  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
    let options <font color="#990000">=</font> <font color="#FF0000">{}</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>DEBUG<font color="#990000">)</font> <font color="#FF0000">{</font>
      <i><font color="#9A1900">// customize caching</font></i>
      options<font color="#990000">.</font>cacheControl <font color="#990000">=</font> <font color="#FF0000">{</font>
        bypassCache<font color="#990000">:</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font>
      <font color="#FF0000">}</font><font color="#990000">;</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> method<font color="#990000">,</font> url <font color="#FF0000">}</font> <font color="#990000">=</font> request
    <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> pathname <font color="#FF0000">}</font> <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>url<font color="#990000">)</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>method <font color="#990000">===</font> <font color="#FF0000">"OPTIONS"</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">handleOptions</font></b><font color="#990000">(</font>request<font color="#990000">)</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>pathname<font color="#990000">.</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">'/'</font><font color="#990000">)[</font><font color="#993399">1</font><font color="#990000">]</font> <font color="#990000">===</font> <font color="#FF0000">'api'</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> await <b><font color="#000000">handleApiCall</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>pathname <font color="#990000">===</font> <font color="#FF0000">'/.well-known/apple-app-site-association'</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">universalLinkFile</font></b><font color="#990000">(</font>request<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> pathname <font color="#990000">+</font> <font color="#FF0000">' Not found'</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">404</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>

  <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
    <i><font color="#9A1900">// if an error is thrown try to serve the asset at 404.html</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>DEBUG<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Not found'</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">404</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>

    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> e<font color="#990000">.</font>message <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">404</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>
<b><font color="#0000FF">function</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> contents<font color="#990000">,</font> s<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">const</font></b> corsHeaders <font color="#990000">=</font> <font color="#FF0000">{</font>
    <font color="#FF0000">"Access-Control-Allow-Methods"</font><font color="#990000">:</font> <font color="#FF0000">"POST, OPTIONS, GET"</font><font color="#990000">,</font>
    <font color="#FF0000">"Access-Control-Allow-Headers"</font><font color="#990000">:</font> <font color="#FF0000">"Content-Type, authorization"</font><font color="#990000">,</font>
    <font color="#FF0000">'Content-Type'</font><font color="#990000">:</font> <font color="#FF0000">'application/json;'</font><font color="#990000">,</font>
    <font color="#FF0000">"Access-Control-Allow-Origin"</font><font color="#990000">:</font> request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Origin"</font><font color="#990000">)</font>
  <font color="#FF0000">}</font>
  <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font>contents<font color="#990000">,</font> <font color="#FF0000">{</font> status<font color="#990000">:</font> s<font color="#990000">,</font> headers<font color="#990000">:</font> corsHeaders <font color="#FF0000">}</font><font color="#990000">);</font>
<font color="#FF0000">}</font>

<b><font color="#0000FF">function</font></b> <b><font color="#000000">handleOptions</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Origin"</font><font color="#990000">)</font> <font color="#990000">!==</font> <b><font color="#0000FF">null</font></b> <font color="#990000">&amp;&amp;</font>
    request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Access-Control-Request-Method"</font><font color="#990000">)</font> <font color="#990000">!==</font> <b><font color="#0000FF">null</font></b> <font color="#990000">&amp;&amp;</font>
    request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Access-Control-Request-Headers"</font><font color="#990000">)</font> <font color="#990000">!==</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> <b><font color="#0000FF">null</font></b><font color="#990000">,</font> <font color="#993399">200</font><font color="#990000">)</font>
  <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
    <i><font color="#9A1900">// Handle standard OPTIONS request.</font></i>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font><b><font color="#0000FF">null</font></b><font color="#990000">,</font> <font color="#FF0000">{</font>
      headers<font color="#990000">:</font> <font color="#FF0000">{</font>
        <font color="#FF0000">"Allow"</font><font color="#990000">:</font> <font color="#FF0000">"POST, OPTIONS"</font><font color="#990000">,</font>
      <font color="#FF0000">}</font>
    <font color="#FF0000">}</font><font color="#990000">)</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

async <b><font color="#0000FF">function</font></b> <b><font color="#000000">handleApiCall</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> pathname <font color="#FF0000">}</font> <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
  <b><font color="#0000FF">const</font></b> fname <font color="#990000">=</font> pathname<font color="#990000">.</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">'/'</font><font color="#990000">)[</font><font color="#993399">3</font><font color="#990000">];</font>
  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
    <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>fname<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">case</font></b> <font color="#FF0000">'storeRequest'</font><font color="#990000">:</font>
        <b><font color="#0000FF">return</font></b> await <b><font color="#000000">handleStoreRequest</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font>
      <b><font color="#0000FF">case</font></b> <font color="#FF0000">'storeData'</font><font color="#990000">:</font>
        <b><font color="#0000FF">return</font></b> await <b><font color="#000000">handleStoreData</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font>
      <b><font color="#0000FF">case</font></b> <font color="#FF0000">'fetchData'</font><font color="#990000">:</font>
        <b><font color="#0000FF">return</font></b> await <b><font color="#000000">handleFetchData</font></b><font color="#990000">(</font>request<font color="#990000">,</font> <font color="#FF0000">"p"</font><font color="#990000">,</font> env<font color="#990000">)</font>
      <b><font color="#0000FF">case</font></b> <font color="#FF0000">'migrateStorage'</font><font color="#990000">:</font>
        <b><font color="#0000FF">return</font></b> await <b><font color="#000000">handleMigrateStorage</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font>
      <b><font color="#0000FF">case</font></b> <font color="#FF0000">'fetchDataMigration'</font><font color="#990000">:</font>
        <b><font color="#0000FF">return</font></b> await <b><font color="#000000">handleFetchDataMigration</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font>
      <b><font color="#0000FF">case</font></b> <font color="#FF0000">'robots.txt'</font><font color="#990000">:</font>
        <i><font color="#9A1900">// TODO ... if there's something better to return, otherwise error</font></i>
        <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> <font color="#FF0000">"Disallow: /"</font><font color="#990000">,</font> <font color="#993399">500</font><font color="#990000">);</font>
      <b><font color="#0000FF">default</font></b><font color="#990000">:</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#000000">handleDevelopmentMode</font></b><font color="#990000">();</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">)</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> error <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

<b><font color="#0000FF">function</font></b> <b><font color="#000000">handleDevelopmentMode</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>

  <b><font color="#0000FF">const</font></b> html <font color="#990000">=</font> `<font color="#990000">&lt;!</font>doctypehtml<font color="#990000">&gt;</font> <font color="#990000">&lt;</font>html<font color="#990000">&gt;</font> <font color="#990000">&lt;</font>body<font color="#990000">&gt;</font> <font color="#990000">&lt;</font>div style<font color="#990000">=</font><font color="#FF0000">"display: block; font-weight: bold; padding: 5%; margin: auto; font-family: countach,sans-serif; line-height: 1; margin: 0;"</font><font color="#990000">&gt;</font> <font color="#990000">&lt;</font>h1 style<font color="#990000">=</font><font color="#FF0000">"text-align: center;"</font><font color="#990000">&gt;</font> This feature is currently under development<font color="#990000">.</font> Stay tuned<font color="#990000">!</font> <font color="#990000">&lt;</font><font color="#FF6600">/h3&gt; &lt;/</font>div<font color="#990000">&gt;</font> <font color="#990000">&lt;</font><font color="#FF6600">/body&gt; &lt;/</font>html<font color="#990000">&gt;</font>
  `
  <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font>html<font color="#990000">,</font> <font color="#FF0000">{</font>
    headers<font color="#990000">:</font> <font color="#FF0000">{</font>
      <font color="#FF0000">"content-type"</font><font color="#990000">:</font> <font color="#FF0000">"text/html;charset=UTF-8"</font><font color="#990000">,</font>
    <font color="#FF0000">}</font><font color="#990000">,</font>
  <font color="#FF0000">}</font><font color="#990000">)</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// async function verifyCookie(request, env) {</font></i>

<i><font color="#9A1900">//   // Parse cookie code from https://stackoverflow.com/questions/51812422/node-js-how-can-i-get-cookie-value-by-cookie-name-from-request</font></i>
<i><font color="#9A1900">//   try {</font></i>
<i><font color="#9A1900">//     console.log("In verify cookie")</font></i>
<i><font color="#9A1900">//     let cookies = {};</font></i>
<i><font color="#9A1900">//     const { searchParams } = new URL(request.url);</font></i>
<i><font color="#9A1900">//     const room_id = searchParams.get('roomId');</font></i>
<i><font color="#9A1900">//     request.headers.has('cookie') &amp;&amp; request.headers.get('cookie').split(';').forEach(function (cookie) {</font></i>
<i><font color="#9A1900">//       let parts = cookie.match(/(.*?)=(.*)$/)</font></i>
<i><font color="#9A1900">//       cookies[parts[1].trim()] = (parts[2] || '').trim();</font></i>
<i><font color="#9A1900">//     });</font></i>
<i><font color="#9A1900">//     if (!cookies.hasOwnProperty('token_' + room_id)) {</font></i>
<i><font color="#9A1900">//       return false;</font></i>
<i><font color="#9A1900">//     }</font></i>
<i><font color="#9A1900">//     console.log(cookies);</font></i>
<i><font color="#9A1900">//     const verificationKey = await crypto.subtle.importKey("jwk", JSON.parse(await env.KEYS_NAMESPACE.get(room_id + '_authorizationKey')), { name: "ECDSA", namedCurve: "P-384" }, false, ["verify"]);</font></i>
<i><font color="#9A1900">//     const auth_parts = cookies['token_' + room_id].split('.');</font></i>
<i><font color="#9A1900">//     const payload = auth_parts[0];</font></i>
<i><font color="#9A1900">//     const sign = auth_parts[1];</font></i>
<i><font color="#9A1900">//     //console.log(payload, sign);</font></i>
<i><font color="#9A1900">//     return (await verifySign(verificationKey, sign, payload + '_' + room_id) &amp;&amp; ((new Date()).getTime() - parseInt(payload)) &lt; 86400000);</font></i>
<i><font color="#9A1900">//   } catch (error) {</font></i>
<i><font color="#9A1900">//     return false;</font></i>
<i><font color="#9A1900">//   }</font></i>
<i><font color="#9A1900">// }</font></i>



<i><font color="#9A1900">// async function verifySign(secretKey, sign, contents) {</font></i>
<i><font color="#9A1900">//   try {</font></i>
<i><font color="#9A1900">//     const _sign = utils.base64ToArrayBuffer(decodeURIComponent(sign));</font></i>
<i><font color="#9A1900">//     const encoder = new TextEncoder();</font></i>
<i><font color="#9A1900">//     const encoded = encoder.encode(contents);</font></i>
<i><font color="#9A1900">//     //console.log(secretKey, _sign, encoded)</font></i>
<i><font color="#9A1900">//     let verified = await crypto.subtle.verify(</font></i>
<i><font color="#9A1900">//       { name: 'ECDSA', hash: 'SHA-256' },</font></i>
<i><font color="#9A1900">//       secretKey,</font></i>
<i><font color="#9A1900">//       _sign,</font></i>
<i><font color="#9A1900">//       encoded</font></i>
<i><font color="#9A1900">//     );</font></i>
<i><font color="#9A1900">//     //console.log("TRUE");</font></i>
<i><font color="#9A1900">//     return verified;</font></i>
<i><font color="#9A1900">//   } catch (e) {</font></i>
<i><font color="#9A1900">//     console.log(e)</font></i>
<i><font color="#9A1900">//     //console.log("FALSE");</font></i>
<i><font color="#9A1900">//     return false;</font></i>
<i><font color="#9A1900">//   }</font></i>
<i><font color="#9A1900">// }</font></i>


async <b><font color="#0000FF">function</font></b> <b><font color="#000000">handleStoreRequest</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> searchParams <font color="#FF0000">}</font> <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> name <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'name'</font><font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> list_resp <font color="#990000">=</font> await env<font color="#990000">.</font>IMAGES_NAMESPACE<font color="#990000">.</font><b><font color="#000000">list</font></b><font color="#990000">(</font><font color="#FF0000">{</font> <font color="#FF0000">'prefix'</font><font color="#990000">:</font> name <font color="#FF0000">}</font><font color="#990000">);</font>
    let data <font color="#990000">=</font> <font color="#FF0000">{}</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>list_resp<font color="#990000">.</font>keys<font color="#990000">.</font>length <font color="#990000">&gt;</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> key <font color="#990000">=</font> list_resp<font color="#990000">.</font>keys<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">].</font>name<font color="#990000">;</font>
      <b><font color="#0000FF">const</font></b> val <font color="#990000">=</font> await env<font color="#990000">.</font>IMAGES_NAMESPACE<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>key<font color="#990000">,</font> <font color="#FF0000">{</font> type<font color="#990000">:</font> <font color="#FF0000">"arrayBuffer"</font> <font color="#FF0000">}</font><font color="#990000">);</font>
      data <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">extractPayload</font></b><font color="#990000">(</font>val<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">const</font></b> salt <font color="#990000">=</font> Object<font color="#990000">.</font><b><font color="#0000FF">prototype</font></b><font color="#990000">.</font>hasOwnProperty<font color="#990000">.</font><b><font color="#000000">call</font></b><font color="#990000">(</font>data<font color="#990000">,</font> <font color="#FF0000">'salt'</font><font color="#990000">)</font> <font color="#990000">?</font> data<font color="#990000">.</font>salt <font color="#990000">:</font> crypto<font color="#990000">.</font><b><font color="#000000">getRandomValues</font></b><font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font><font color="#993399">16</font><font color="#990000">));</font>
    <b><font color="#0000FF">const</font></b> iv <font color="#990000">=</font> Object<font color="#990000">.</font><b><font color="#0000FF">prototype</font></b><font color="#990000">.</font>hasOwnProperty<font color="#990000">.</font><b><font color="#000000">call</font></b><font color="#990000">(</font>data<font color="#990000">,</font> <font color="#FF0000">'iv'</font><font color="#990000">)</font> <font color="#990000">?</font> data<font color="#990000">.</font>iv <font color="#990000">:</font> crypto<font color="#990000">.</font><b><font color="#000000">getRandomValues</font></b><font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint8Array</font></b><font color="#990000">(</font><font color="#993399">12</font><font color="#990000">));</font>
    <i><font color="#9A1900">// subtle not doing this:</font></i>
    <i><font color="#9A1900">// const salt = data.hasOwnProperty('salt') ? data.salt : crypto.getRandomValues(new Uint8Array(16));</font></i>
    <i><font color="#9A1900">// const iv = data.hasOwnProperty('iv') ? data.iv : crypto.getRandomValues(new Uint8Array(12));</font></i>

    <b><font color="#0000FF">const</font></b> return_data <font color="#990000">=</font> <font color="#FF0000">{</font> iv<font color="#990000">:</font> iv<font color="#990000">,</font> salt<font color="#990000">:</font> salt <font color="#FF0000">}</font><font color="#990000">;</font>
    <b><font color="#0000FF">const</font></b> payload <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">assemblePayload</font></b><font color="#990000">(</font>return_data<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> corsHeaders <font color="#990000">=</font> <font color="#FF0000">{</font>
      <font color="#FF0000">"Access-Control-Allow-Methods"</font><font color="#990000">:</font> <font color="#FF0000">"POST, OPTIONS, GET"</font><font color="#990000">,</font>
      <font color="#FF0000">"Access-Control-Allow-Headers"</font><font color="#990000">:</font> <font color="#FF0000">"Content-Type"</font><font color="#990000">,</font>
      <font color="#FF0000">"Access-Control-Allow-Origin"</font><font color="#990000">:</font> request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Origin"</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font>payload<font color="#990000">,</font> <font color="#FF0000">{</font> status<font color="#990000">:</font> <font color="#993399">200</font><font color="#990000">,</font> headers<font color="#990000">:</font> corsHeaders <font color="#FF0000">}</font><font color="#990000">);</font>

  <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">);</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> error <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">)</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

async <b><font color="#0000FF">function</font></b> <b><font color="#000000">handleStoreData</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> searchParams <font color="#FF0000">}</font> <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> image_id <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'key'</font><font color="#990000">);</font>
    <i><font color="#9A1900">// console.log(image_id)</font></i>
    <b><font color="#0000FF">const</font></b> type <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'type'</font><font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> key <font color="#990000">=</font> <font color="#FF0000">"____"</font> <font color="#990000">+</font> type <font color="#990000">+</font> <font color="#FF0000">"__"</font> <font color="#990000">+</font> image_id <font color="#990000">+</font> <font color="#FF0000">"______"</font><font color="#990000">;</font>
    <i><font color="#9A1900">// console.log(key, await IMAGES_NAMESPACE.get(key))</font></i>
    <b><font color="#0000FF">const</font></b> val <font color="#990000">=</font> await request<font color="#990000">.</font><b><font color="#000000">arrayBuffer</font></b><font color="#990000">();</font>
    <b><font color="#0000FF">const</font></b> data <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">extractPayload</font></b><font color="#990000">(</font>val<font color="#990000">);</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"EXTRACTED DATA IN MAIN: "</font><font color="#990000">,</font> Object<font color="#990000">.</font><b><font color="#000000">keys</font></b><font color="#990000">(</font>data<font color="#990000">))</font>
    <i><font color="#9A1900">// const storageToken = data.storageToken;</font></i>
    let verification_token<font color="#990000">;</font>

    <b><font color="#0000FF">const</font></b> _storage_token <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">((</font><b><font color="#0000FF">new</font></b> TextDecoder<font color="#990000">).</font><b><font color="#000000">decode</font></b><font color="#990000">(</font>data<font color="#990000">.</font>storageToken<font color="#990000">));</font>
    let _ledger_resp <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>await env<font color="#990000">.</font>LEDGER_NAMESPACE<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>_storage_token<font color="#990000">.</font>token_hash<font color="#990000">));</font>

    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#000000">verifyStorage</font></b><font color="#990000">(</font>data<font color="#990000">,</font> image_id<font color="#990000">,</font> env<font color="#990000">,</font> _ledger_resp<font color="#990000">))</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Ledger(s) refused storage request - authentication or storage budget issue, or malformed request'</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>

    <b><font color="#0000FF">const</font></b> stored_data <font color="#990000">=</font> await env<font color="#990000">.</font>IMAGES_NAMESPACE<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>key<font color="#990000">,</font> <font color="#FF0000">{</font> type<font color="#990000">:</font> <font color="#FF0000">"arrayBuffer"</font> <font color="#FF0000">}</font><font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>stored_data <font color="#990000">==</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
      verification_token <font color="#990000">=</font> crypto<font color="#990000">.</font><b><font color="#000000">getRandomValues</font></b><font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint16Array</font></b><font color="#990000">(</font><font color="#993399">4</font><font color="#990000">)).</font>buffer<font color="#990000">;</font>
      data<font color="#990000">[</font><font color="#FF0000">'verification_token'</font><font color="#990000">]</font> <font color="#990000">=</font> verification_token<font color="#990000">;</font>
      await env<font color="#990000">.</font>IMAGES_NAMESPACE<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font>key<font color="#990000">,</font> utils<font color="#990000">.</font><b><font color="#000000">assemblePayload</font></b><font color="#990000">(</font>data<font color="#990000">));</font>
      <i><font color="#9A1900">//console.log("Generated and stored verification token", store_resp);</font></i>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> data <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">extractPayload</font></b><font color="#990000">(</font>stored_data<font color="#990000">);</font>
      <i><font color="#9A1900">// console.log('Data', data);</font></i>
      verification_token <font color="#990000">=</font> data<font color="#990000">.</font>verification_token<font color="#990000">;</font>
    <font color="#FF0000">}</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Extracted data: "</font><font color="#990000">,</font> data<font color="#990000">)</font>

    _ledger_resp<font color="#990000">.</font>used <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
    let _put_resp <font color="#990000">=</font> await env<font color="#990000">.</font>LEDGER_NAMESPACE<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font>_storage_token<font color="#990000">.</font>token_hash<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>_ledger_resp<font color="#990000">));</font>
    env<font color="#990000">.</font>RECOVERY_NAMESPACE<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font>_storage_token<font color="#990000">.</font>hashed_room_id <font color="#990000">+</font> <font color="#FF0000">'_'</font> <font color="#990000">+</font> _storage_token<font color="#990000">.</font>encrypted_token_id<font color="#990000">,</font> <font color="#FF0000">'true'</font><font color="#990000">);</font>
    env<font color="#990000">.</font>RECOVERY_NAMESPACE<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font>_storage_token<font color="#990000">.</font>token_hash <font color="#990000">+</font> <font color="#FF0000">'_'</font> <font color="#990000">+</font> image_id<font color="#990000">,</font> <font color="#FF0000">'true'</font><font color="#990000">);</font>
    env<font color="#990000">.</font>RECOVERY_NAMESPACE<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font>image_id <font color="#990000">+</font> <font color="#FF0000">'_'</font> <font color="#990000">+</font> _storage_token<font color="#990000">.</font>token_hash<font color="#990000">,</font> <font color="#FF0000">'true'</font><font color="#990000">);</font>
    <i><font color="#9A1900">// await fetch('https://s_socket.privacy.app/api/token/' + new TextDecoder().decode(storageToken) + '/useToken');</font></i>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> image_id<font color="#990000">:</font> image_id<font color="#990000">,</font> size<font color="#990000">:</font> val<font color="#990000">.</font>byteLength<font color="#990000">,</font> verification_token<font color="#990000">:</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint16Array</font></b><font color="#990000">(</font>verification_token<font color="#990000">).</font><b><font color="#000000">join</font></b><font color="#990000">(</font><font color="#FF0000">''</font><font color="#990000">),</font> ledger_resp<font color="#990000">:</font> _put_resp <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
  <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Error posting image: "</font><font color="#990000">,</font> error<font color="#990000">);</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> error<font color="#990000">.</font><b><font color="#000000">toString</font></b><font color="#990000">()</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">)</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

async <b><font color="#0000FF">function</font></b> <b><font color="#000000">handleFetchData</font></b><font color="#990000">(</font>request<font color="#990000">,</font> type<font color="#990000">,</font> env<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> searchParams <font color="#FF0000">}</font> <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> verification_token <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'verification_token'</font><font color="#990000">);</font>
    <i><font color="#9A1900">// const storage_token = searchParams.get('storage_token');</font></i>
    <b><font color="#0000FF">const</font></b> id <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'id'</font><font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> key <font color="#990000">=</font> <font color="#FF0000">"____"</font> <font color="#990000">+</font> type <font color="#990000">+</font> <font color="#FF0000">"__"</font> <font color="#990000">+</font> id <font color="#990000">+</font> <font color="#FF0000">"______"</font><font color="#990000">;</font>
    <b><font color="#0000FF">const</font></b> stored_data <font color="#990000">=</font> await env<font color="#990000">.</font>IMAGES_NAMESPACE<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>key<font color="#990000">,</font> <font color="#FF0000">{</font> type<font color="#990000">:</font> <font color="#FF0000">"arrayBuffer"</font> <font color="#FF0000">}</font><font color="#990000">);</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Stored data"</font><font color="#990000">,</font> stored_data<font color="#990000">)</font>
    <b><font color="#0000FF">const</font></b> data <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">extractPayload</font></b><font color="#990000">(</font>stored_data<font color="#990000">);</font>
    <i><font color="#9A1900">// const storage_resp = await (await fetch('https://s_socket.privacy.app/api/token/' + storage_token + '/checkUsage')).json();</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>verification_token <font color="#990000">!==</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint16Array</font></b><font color="#990000">(</font>data<font color="#990000">.</font>verification_token<font color="#990000">).</font><b><font color="#000000">join</font></b><font color="#990000">(</font><font color="#FF0000">''</font><font color="#990000">))</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Verification failed'</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">const</font></b> corsHeaders <font color="#990000">=</font> <font color="#FF0000">{</font>
      <font color="#FF0000">"Access-Control-Allow-Methods"</font><font color="#990000">:</font> <font color="#FF0000">"POST, OPTIONS, GET"</font><font color="#990000">,</font>
      <font color="#FF0000">"Access-Control-Allow-Headers"</font><font color="#990000">:</font> <font color="#FF0000">"Content-Type"</font><font color="#990000">,</font>
      <font color="#FF0000">"Access-Control-Allow-Origin"</font><font color="#990000">:</font> request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Origin"</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font>utils<font color="#990000">.</font><b><font color="#000000">assemblePayload</font></b><font color="#990000">(</font>data<font color="#990000">),</font> <font color="#FF0000">{</font> status<font color="#990000">:</font> <font color="#993399">200</font><font color="#990000">,</font> headers<font color="#990000">:</font> corsHeaders <font color="#FF0000">}</font><font color="#990000">);</font>
  <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> error<font color="#990000">.</font><b><font color="#000000">toString</font></b><font color="#990000">()</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">)</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>


async <b><font color="#0000FF">function</font></b> <b><font color="#000000">verifyStorage</font></b><font color="#990000">(</font>data<font color="#990000">,</font> id<font color="#990000">,</font> env<font color="#990000">,</font> _ledger_resp<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">const</font></b> dataHash <font color="#990000">=</font> await <b><font color="#000000">generateDataHash</font></b><font color="#990000">(</font>data<font color="#990000">.</font>contents<font color="#990000">);</font>
  <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>id<font color="#990000">.</font><b><font color="#000000">slice</font></b><font color="#990000">(-</font>dataHash<font color="#990000">.</font>length<font color="#990000">)</font> <font color="#990000">!==</font> dataHash<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
  <font color="#FF0000">}</font>
  <i><font color="#9A1900">// older design ... we think ...</font></i>
  <i><font color="#9A1900">// const ledger_data = JSON.parse((new TextDecoder()).decode(data.storageToken)) || {};</font></i>
  <i><font color="#9A1900">// const token_hash = ledger_data.token_hash_buffer;</font></i>
  <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>_ledger_resp <font color="#990000">||</font> _ledger_resp<font color="#990000">.</font>used <font color="#990000">||</font> _ledger_resp<font color="#990000">.</font>size <font color="#990000">!==</font> data<font color="#990000">.</font>image<font color="#990000">.</font>byteLength<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
  <font color="#FF0000">}</font>
  <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

async <b><font color="#0000FF">function</font></b> <b><font color="#000000">generateDataHash</font></b><font color="#990000">(</font>data<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> digest <font color="#990000">=</font> await crypto<font color="#990000">.</font>subtle<font color="#990000">.</font><b><font color="#000000">digest</font></b><font color="#990000">(</font><font color="#FF0000">'SHA-256'</font><font color="#990000">,</font> data<font color="#990000">);</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>utils<font color="#990000">.</font><b><font color="#000000">arrayBufferToBase64</font></b><font color="#990000">(</font>digest<font color="#990000">));</font>
  <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>e<font color="#990000">)</font> <font color="#FF0000">{</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>e<font color="#990000">);</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">null</font></b><font color="#990000">;</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

<b><font color="#0000FF">function</font></b> <b><font color="#000000">universalLinkFile</font></b><font color="#990000">(</font>request<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">const</font></b> corsHeaders <font color="#990000">=</font> <font color="#FF0000">{</font>
    <font color="#FF0000">"Access-Control-Allow-Methods"</font><font color="#990000">:</font> <font color="#FF0000">"POST, OPTIONS, GET"</font><font color="#990000">,</font>
    <font color="#FF0000">"Access-Control-Allow-Headers"</font><font color="#990000">:</font> <font color="#FF0000">"Content-Type"</font><font color="#990000">,</font>
    <font color="#FF0000">"Access-Control-Allow-Origin"</font><font color="#990000">:</font> request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Origin"</font><font color="#990000">)</font>
  <font color="#FF0000">}</font>
  let json <font color="#990000">=</font> <font color="#FF0000">{</font>
    <font color="#FF0000">"applinks"</font><font color="#990000">:</font> <font color="#FF0000">{</font>
      <font color="#FF0000">"details"</font><font color="#990000">:</font> <font color="#990000">[</font>
        <font color="#FF0000">{</font>
          <font color="#FF0000">"appIDs"</font><font color="#990000">:</font> <font color="#990000">[</font><font color="#FF0000">"BFX746944J.app.snackabra"</font><font color="#990000">],</font>
          <font color="#FF0000">"components"</font><font color="#990000">:</font> <font color="#990000">[</font>
            <font color="#FF0000">{</font>
              <font color="#FF0000">"/"</font><font color="#990000">:</font> <font color="#FF0000">"*"</font><font color="#990000">,</font>
              <font color="#FF0000">"comment"</font><font color="#990000">:</font> <font color="#FF0000">"Matches any URL"</font>
            <font color="#FF0000">}</font>
          <font color="#990000">]</font>
        <font color="#FF0000">}</font>
      <font color="#990000">]</font>
    <font color="#FF0000">}</font>
  <font color="#FF0000">}</font>
  let file <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Blob</font></b><font color="#990000">([</font>JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font>json<font color="#990000">)],</font> <font color="#FF0000">{</font> type<font color="#990000">:</font> <font color="#FF0000">'application/json'</font> <font color="#FF0000">}</font><font color="#990000">);</font>
  <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font>file<font color="#990000">,</font> <font color="#FF0000">{</font> status<font color="#990000">:</font> <font color="#993399">200</font><font color="#990000">,</font> headers<font color="#990000">:</font> corsHeaders <font color="#FF0000">}</font><font color="#990000">);</font>
<font color="#FF0000">}</font>

async <b><font color="#0000FF">function</font></b> <b><font color="#000000">handleMigrateStorage</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"In handleMigrate"</font><font color="#990000">);</font>
    let data <font color="#990000">=</font> await request<font color="#990000">.</font><b><font color="#000000">arrayBuffer</font></b><font color="#990000">();</font>
    let jsonString <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">TextDecoder</font></b><font color="#990000">().</font><b><font color="#000000">decode</font></b><font color="#990000">(</font>data<font color="#990000">);</font>
    let json <font color="#990000">=</font> JSON<font color="#990000">.</font><b><font color="#000000">parse</font></b><font color="#990000">(</font>jsonString<font color="#990000">);</font>
    let targetURL <font color="#990000">=</font> json<font color="#990000">[</font><font color="#FF0000">'target'</font><font color="#990000">];</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"TargetURL: "</font><font color="#990000">,</font> targetURL<font color="#990000">)</font>
    <b><font color="#0000FF">delete</font></b> json<font color="#990000">[</font><font color="#FF0000">'target'</font><font color="#990000">];</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>Object<font color="#990000">.</font><b><font color="#0000FF">prototype</font></b><font color="#990000">.</font>hasOwnProperty<font color="#990000">.</font><b><font color="#000000">call</font></b><font color="#990000">(</font>json<font color="#990000">,</font> <font color="#FF0000">'SERVER_SECRET'</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">!(</font>json<font color="#990000">[</font><font color="#FF0000">'SERVER_SECRET'</font><font color="#990000">]</font> <font color="#990000">===</font> env<font color="#990000">.</font>SERVER_SECRET<font color="#990000">))</font> <font color="#FF0000">{</font> <i><font color="#9A1900">// yes you just need one '!'</font></i>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Server verification failed"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">delete</font></b> json<font color="#990000">[</font><font color="#FF0000">'SERVER_SECRET'</font><font color="#990000">]</font>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font>let key <b><font color="#0000FF">in</font></b> json<font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">const</font></b> key_parts <font color="#990000">=</font> key<font color="#990000">.</font><b><font color="#000000">split</font></b><font color="#990000">(</font><font color="#FF0000">"."</font><font color="#990000">);</font>
      <b><font color="#0000FF">const</font></b> key_id <font color="#990000">=</font> key_parts<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">];</font>
      let type <font color="#990000">=</font> key_parts<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">];</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>type <font color="#990000">!==</font> <font color="#FF0000">"p"</font> <font color="#990000">&amp;&amp;</font> type <font color="#990000">!==</font> <font color="#FF0000">"f"</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        type <font color="#990000">=</font> <font color="#FF0000">"p"</font><font color="#990000">;</font>
      <font color="#FF0000">}</font>
      let reqUrl <font color="#990000">=</font> <font color="#FF0000">"https://"</font> <font color="#990000">+</font> targetURL <font color="#990000">+</font> <font color="#FF0000">"/api/v1/fetchDataMigration?id="</font> <font color="#990000">+</font> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>key_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">"&amp;verification_token="</font> <font color="#990000">+</font> json<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">+</font> <font color="#FF0000">"&amp;type="</font> <font color="#990000">+</font> type<font color="#990000">;</font>
      let fetch_req <font color="#990000">=</font> await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>reqUrl<font color="#990000">);</font>
      <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fetch_req<font color="#990000">.</font>status <font color="#990000">===</font> <font color="#993399">500</font> <font color="#990000">&amp;&amp;</font> type <font color="#990000">!==</font> <font color="#FF0000">"f"</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        type <font color="#990000">=</font> <font color="#FF0000">"f"</font><font color="#990000">;</font>
        reqUrl <font color="#990000">=</font> <font color="#FF0000">"https://"</font> <font color="#990000">+</font> targetURL <font color="#990000">+</font> <font color="#FF0000">"/api/v1/fetchDataMigration?id="</font> <font color="#990000">+</font> <b><font color="#000000">encodeURIComponent</font></b><font color="#990000">(</font>key_id<font color="#990000">)</font> <font color="#990000">+</font> <font color="#FF0000">"&amp;verification_token="</font> <font color="#990000">+</font> json<font color="#990000">[</font>key<font color="#990000">]</font> <font color="#990000">+</font> <font color="#FF0000">"&amp;type="</font> <font color="#990000">+</font> type<font color="#990000">;</font>
        fetch_req <font color="#990000">=</font> await <b><font color="#000000">fetch</font></b><font color="#990000">(</font>reqUrl<font color="#990000">);</font>
      <font color="#FF0000">}</font>
      let ab <font color="#990000">=</font> await fetch_req<font color="#990000">.</font><b><font color="#000000">arrayBuffer</font></b><font color="#990000">();</font>
      <b><font color="#0000FF">const</font></b> kv_key <font color="#990000">=</font> <font color="#FF0000">"____"</font> <font color="#990000">+</font> type <font color="#990000">+</font> <font color="#FF0000">"__"</font> <font color="#990000">+</font> key_id <font color="#990000">+</font> <font color="#FF0000">"______"</font><font color="#990000">;</font>
      env<font color="#990000">.</font>IMAGES_NAMESPACE<font color="#990000">.</font><b><font color="#000000">put</font></b><font color="#990000">(</font>kv_key<font color="#990000">,</font> ab<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> success<font color="#990000">:</font> <b><font color="#0000FF">true</font></b> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">)</font>
  <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font>error<font color="#990000">)</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> error<font color="#990000">.</font>message <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">);</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

async <b><font color="#0000FF">function</font></b> <b><font color="#000000">handleFetchDataMigration</font></b><font color="#990000">(</font>request<font color="#990000">,</font> env<font color="#990000">)</font> <font color="#FF0000">{</font>
  <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> <font color="#FF0000">{</font> searchParams <font color="#FF0000">}</font> <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">URL</font></b><font color="#990000">(</font>request<font color="#990000">.</font>url<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> verification_token <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'verification_token'</font><font color="#990000">);</font>
    <i><font color="#9A1900">// const storage_token = searchParams.get('storage_token');</font></i>
    <b><font color="#0000FF">const</font></b> id <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'id'</font><font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> type <font color="#990000">=</font> searchParams<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">'type'</font><font color="#990000">)</font>
    <b><font color="#0000FF">const</font></b> key <font color="#990000">=</font> <font color="#FF0000">"____"</font> <font color="#990000">+</font> type <font color="#990000">+</font> <font color="#FF0000">"__"</font> <font color="#990000">+</font> id <font color="#990000">+</font> <font color="#FF0000">"______"</font><font color="#990000">;</font>
    <b><font color="#0000FF">const</font></b> stored_data <font color="#990000">=</font> await env<font color="#990000">.</font>IMAGES_NAMESPACE<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font>key<font color="#990000">,</font> <font color="#FF0000">{</font> type<font color="#990000">:</font> <font color="#FF0000">"arrayBuffer"</font> <font color="#FF0000">}</font><font color="#990000">);</font>
    console<font color="#990000">.</font><b><font color="#000000">log</font></b><font color="#990000">(</font><font color="#FF0000">"Stored data"</font><font color="#990000">,</font> stored_data<font color="#990000">)</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>stored_data <font color="#990000">==</font> <b><font color="#0000FF">null</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">"Could not find data"</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">const</font></b> data <font color="#990000">=</font> utils<font color="#990000">.</font><b><font color="#000000">extractPayload</font></b><font color="#990000">(</font>stored_data<font color="#990000">);</font>
    <i><font color="#9A1900">// const storage_resp = await (await fetch('https://s_socket.privacy.app/api/token/' + storage_token + '/checkUsage')).json();</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>verification_token <font color="#990000">!==</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Uint16Array</font></b><font color="#990000">(</font>data<font color="#990000">.</font>verification_token<font color="#990000">).</font><b><font color="#000000">join</font></b><font color="#990000">(</font><font color="#FF0000">''</font><font color="#990000">))</font> <font color="#FF0000">{</font>
      <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> <font color="#FF0000">'Verification failed'</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">200</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">const</font></b> corsHeaders <font color="#990000">=</font> <font color="#FF0000">{</font>
      <font color="#FF0000">"Access-Control-Allow-Methods"</font><font color="#990000">:</font> <font color="#FF0000">"POST, OPTIONS, GET"</font><font color="#990000">,</font>
      <font color="#FF0000">"Access-Control-Allow-Headers"</font><font color="#990000">:</font> <font color="#FF0000">"Content-Type"</font><font color="#990000">,</font>
      <font color="#FF0000">"Access-Control-Allow-Origin"</font><font color="#990000">:</font> request<font color="#990000">.</font>headers<font color="#990000">.</font><b><font color="#000000">get</font></b><font color="#990000">(</font><font color="#FF0000">"Origin"</font><font color="#990000">)</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Response</font></b><font color="#990000">(</font>utils<font color="#990000">.</font><b><font color="#000000">assemblePayload</font></b><font color="#990000">(</font>data<font color="#990000">),</font> <font color="#FF0000">{</font> status<font color="#990000">:</font> <font color="#993399">200</font><font color="#990000">,</font> headers<font color="#990000">:</font> corsHeaders <font color="#FF0000">}</font><font color="#990000">);</font>
  <font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font>error<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">return</font></b> <b><font color="#000000">returnResult</font></b><font color="#990000">(</font>request<font color="#990000">,</font> JSON<font color="#990000">.</font><b><font color="#000000">stringify</font></b><font color="#990000">(</font><font color="#FF0000">{</font> error<font color="#990000">:</font> error<font color="#990000">.</font><b><font color="#000000">toString</font></b><font color="#990000">()</font> <font color="#FF0000">}</font><font color="#990000">),</font> <font color="#993399">500</font><font color="#990000">)</font>
  <font color="#FF0000">}</font>
<font color="#FF0000">}</font>
</tt></pre>
